%\chapter{det-overview}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Detector Requirements}\label{sec:detector_requirements}

insert detector overview here \fixme{The whole chapter is `overview'; insert detector requirements here! Link added.}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Liquid argon detector properties}
- Electron drift + LAr purity etc.
- LAr scintillation light 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{TPC Signal Formation}\label{sec:tpc_signal_formation}


The principle of a large single-phase LArTPC with wire readout is shown in 
Figure~\ref{fig:signal}. When charged particles traverse the LAr,
ionization electrons are generated. They %would 
travel at a constant speed 
($\sim$1.6 km/s at 500~V/cm electric field) along the electric field 
toward the anode plane assembly (APA) which consists of multiple anode wire planes. 
The first two wire planes encountered collect 
an induction signal as the drifting charges pass through.  The charge is collected 
on the wires of the third plane. The transparency of the induction planes is assured by 
applying appropriate bias voltages to all three wire planes. As charges drift pass the induction 
plane wires and are collected on the anode wires
a current is produced on the wires. Since the locations of all wires are 
accurately known, the position of the ionization charge in the direction 
transverse to the drift can be determined in three independent views. The time 
of the initial interaction can be determined by collecting scintillation light 
in a fast optical detector system. By measuring the time from the light signal 
to electrical signals on the wires, it is possible to determine the longitudinal position 
along the drift direction, leading to %. Therefore, one can achieve 
a 3D image of the trajectories 
of the charged particles in the LAr. The amount of ionization electrons depends on 
the energy and type of the initial particles, and can be used to deduce their properties.

\begin{cdrfigure}[The principles of LArTPC technology]{signal}{The principles of LArTPC technology are shown. (left) When energetic, charged particles 
traverse the LAr medium, ionization electrons are produced and move
along the external electric field towards the anode planes. (right) The ionization
electrons pass through the induction wire planes and are  collected by the 
final collection wire plane. 
During this process, signals are measured on the wires
in each plane which provides information about the 3D positions and
energies of initial particles.}
\includegraphics[width=0.48\textwidth]{TPC_1.png}
\includegraphics[width=0.48\textwidth]{TPC_2.png}
\end{cdrfigure}


Figure~\ref{fig:signal_formation} illustrates the major elements of the processes 
involved in forming the TPC signals. When the ionization electrons drift through the 
wire planes, current is induced on the nearby wires. This process is described by the 
field response functions. The physics of the current induction is described by the 
Shockley-Ramo theorem~\cite{Shockley,Ramo}.  For an element of ionization charge, 
the instantaneous, induced current $i$ is proportional to the amount of that
charge $q$: 
\begin{equation}
i = q \cdot \vec{E}_{w} \cdot \vec{v}_q.
\end{equation}
The proportionality factor is product of the weighting field vector $\vec{E}_{w}$ 
at the location of the charge and its drift velocity vector $\vec{v}_q$. 
The weighting field vector $\vec{E}_{w}$, which depends on the geometry of the electrodes, 
can be calculated by removing the charge,  placing the potential of the targeted 
electrode to the unity potential, and setting all other conductors to ground. 
Figure~\ref{fig:signal_formation} shows a calculated weighting potential $V_{w}$ that 
is linked to weighting field $\vec{E}_{w}$ as $\frac{dV_{w}}{d\vec{r}} = \vec{E}_{w}$ for one 
induction plane wire using a 2D simulation based on Garfield~\cite{garfield}. 
In this calculation, the wire pitch is assumed to be 3~mm. There are three wire planes 
with the first two being induction and the last one being collection plane.  

The induced current on the wire is received, amplified, and shaped by
a pre-amplifier. This part is described by the electronics response
function (see Figure~\ref{fig:ele_res}).  
The resulting signal waveform is then digitally sampled at
regular intervals.  This data is referred to as the raw digits.  The
goal of the charge extraction process is to recover the number of
ionization electrons that must have arrived at each anode plane at a
given sample time in order to produce the measured raw digits.  The
information regarding the number, location (in the directions transverse
to and in the plane of the wires) and sample time of ionization
electrons are then used as input to the event reconstruction chain.

\begin{cdrfigure}[The process of TPC signal formation.]{signal_formation}{The process of TPC signal formation (left). The panel on the 
right shows a cross sectional view of the three wire planes (red dots) along with the electric field (orange lines) and the weighting potential 
(green lines) for a single induction wire of the first induction wire plane.}
\includegraphics[width=0.8\textwidth]{Signal_Extraction.png}
\end{cdrfigure}
%\fixme{Left panel of figure should have difference in terminology shown in top most and bottom most box, e.g. "true no. of ionized elec" and "reconstructed ..." -TK }

\begin{cdrfigure}[Simulated electronics response function in the time 
domain at 4.7 mV/fC gain]{ele_res}{The simulated electronics response function in the time 
domain at 4.7 mV/fC gain. The front-end cold electronics are designed to be 
programmable with 4 different gain settings (4.7, 7.8, 14, and 25 mV/fC) and 
4 shaping time settings (0.5, 1, 2, and 3 us). The shaping time is defined as the time 
between peak and 5\% of the peak at the falling edge. For a fixed gain setting, 
the peak is always at the same height independent of the shaping time. }
\includegraphics[width=0.6\textwidth]{electronics_res.pdf}
\end{cdrfigure}


While the principle is straightforward, calculating the measured
current itself can be very complicated. As shown in
Figure~\ref{fig:signal_formation}, the weighting field becomes smaller
at locations further away from the wire of interest.  
The weighting field also extends beyond the ``boundary'' of the wire.
Wire boundaries are defined by imaginary planes parallel to a wire,
perpendicular to the wire's plane and halfway between two neighboring
wires; i.e.,  in an ideal case, all charge produced within a wire's boundary
will drift to its nearest associated wire. 
%Due to the extent of 
Since a weighting field extends beyond a given wire's boundary, electrons drifting inside
this boundary can induce current in other wires.  
The induced currents therefore strongly depend on the local ionization
charge distribution near the wire of interest, which in turn depends
on the event topology of the initial energetic, charged particles.
%This fact makes the induced currents strongly depend on the local ionization charge distribution near the wire of interest, 


To illustrate the complication of the induction plane signal,  
an ideal track with a uniform charge distribution along it %the track 
is shown as 
an example in Figure~\ref{fig:ideal_track_1}. In the left panel, the 
two black lines represent the boundaries of one wire's region. In this case,  
%if one just counts 
counting only the ionization charge distribution within the wire's boundaries,
the expected 
distribution is shown in panel a) at top right.  However, the induced current on the wire of 
interest depends on the weighting field, which is smaller when the ionization electron is 
further away from the wire itself. Therefore, the effective charge distribution seen by 
the wire after considering the strength of weighting potential 
 would be similar to what is shown in panel b) on the right side of 
Figure~\ref{fig:ideal_track_1}. 
%\fixme{Why is signal in b) symmetric, when weighting potential for shown track is not ? - TK}
However, the wire of interest will experience an 
additional induced current from ionization electrons 
drifting outside its boundaries and in the regions of nearby wires. 
Since these ionization electrons are further away, 
the weighting field is even smaller and thus the induction from them is 
also smaller. A realistic effective charge distribution will be similar to the one shown in panel c) on 
the bottom right side of Figure~\ref{fig:ideal_track_1}. 


When the bipolar induction field response function is taken into account the 
charge transients change shape.
In the left panel of Figure~\ref{fig:ideal_track_2}, the top half shows 
the real charge distribution going through the targeted wire region. The convolution of this 
distribution with a bipolar response function will lead to results shown at the bottom. In this 
case, it can be seen that the signal height is still large at least for the start and the end of the 
signal. In the right panel of Figure~\ref{fig:ideal_track_2}, the top half shows the more 
realistic effective charge distribution seen by the targeted wire. The convolution of this 
distribution with a bipolar response function will lead to results shown at the bottom. In 
this case, it is apparent that the signal height is much smaller though the length of the signal is 
longer. This effect leads to complications in designing the data compression algorithm.

\begin{cdrfigure}[Induction plane field response for an ideal track (1)]{ideal_track_1}{Illustration of the induction plane field response for an ideal track (red arrow).}
  \includegraphics[width=0.7\textwidth]{ideal_track.png}
\end{cdrfigure}

\begin{cdrfigure}[Induction plane field response for an ideal track (2)]{ideal_track_2}{Illustration of the induction plane field response for an ideal track.}
\includegraphics[width=0.75\textwidth]{ideal_track_2.png}
\end{cdrfigure}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\input{tpc-signal-extraction.tex}

%   It is:    \section{TPC Charge Extraction}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Space charge effect}

%%%%%%%%%%%%%%%%%%%%%%%%
%%%\subsection{Introduction} 
\label{sec:SCEintro}

In order to correctly reconstruct the trajectories of particles that travel through the active volume of the TPC as well as precisely determine calorimetric information for these particles, it is essential to know very well the magnitude and direction of the drift electric field throughout the TPC bulk.  Nominally the electric field should be uniform throughout the TPC volume.  However, field effects such as the space charge effect (SCE) may cause distortions in the electric field that result in distortions in the reconstructed position of ionization electron clusters detected by the TPC wire planes as well as variation in the relative level of electron-ion recombination in different parts of the TPC~\cite{KirkSCE}.  The space charge effect is the build-up of slow-moving positive ions in a detector due to, for instance, ionization from cosmic muons.  As ProtoDUNE-SP is a detector on the surface with little overburden, the cosmic muon flux is expected to create a significant amount of space charge (positive argon ions) that could modestly impact the drift electric field within the TPC active volume.

In principle this effect could have modest impact in any TPC (liquid or gaseous) if the dimensions of the detector -- in particular the maximal drift distance -- are large enough to accumulate a high ion density.  In these cases, having a robust calibration method is necessary in order to account for the effect in particle trajectory reconstruction and calorimetry.  An example of the impact of the space charge effect on track reconstruction is shown in Figure~\ref{fig:SCEtrackEffects}~\cite{Mooney:2015kke}.  It should be understood that observations of these spatial distortions in data may include other effects, e.g., distortions of the applied field due to geometric and electric potential errors, distortion of the wire geometry, etc.  Within the context of this section, these other possible sources of distortions in reconstructed ionization electron cluster position are ignored as they are expected to be small in comparison with the distortions caused by the SCE.

\begin{cdrfigure}[Impact of the space charge effect on reconstructed tracks in the detector.]{SCEtrackEffects}{Impact of the space charge effect on reconstructed tracks in the detector.  The impact on a reconstructed track can be broken up into two distinct features:  a squeezing of the sides of the tracks in the transverse TPC directions that can somewhat resemble a rotation (``A'') and a bowing of the track toward the cathode that is most pronounced in the middle of the TPC (``B'').}
\includegraphics[width=0.99\linewidth]{trackSCE.pdf}
\end{cdrfigure}


%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Simulation} \label{sec:SCEsim}

Software was developed~\cite{SCEsimNote} to simulate the impact of space charge on the electric field within the TPC, along with the distortions in reconstructed ionization electron position at different points within the TPC bulk.  This simulation makes use of a Fourier series solution to the boundary value problem to solve for the electric field on a three-dimensional grid within the bulk of the TPC, an interpolation in between the grid points using radial basis functions to find the electric field everywhere in the TPC, and ray-tracing using the RKF45\footnote{``RungeKuttaFehlberg 4(5)'' method, an algorithm for the numerical solution of ordinary differential equations.} method in order to simulate the distortions in reconstructed position of ionization electron clusters.

An assumption is made that the charge deposition rate from cosmic muons is uniform across the TPC volume:  $2{\times}10^{-10}~\mathrm{C}/\mathrm{m}^{3}/\mathrm{s}$ at a drift field of 500~V/cm~\cite{KirkSCE}.  As a result, ignoring higher-order effects of the electric field distortions on the space charge configuration itself, the space charge density is linear with respect to the distance from the anode plane.  The space charge density profile used in the simulation is shown in Figure~\ref{fig:simSCDist} for a drift field of 500~V/cm.

\begin{cdrfigure}[Space charge density $\rho$ as a function of the $x$ position assumed in the simulation]{simSCDist}{Space charge density $\rho$ as a function of the $x$ position assumed in the simulation. The space charge density at the cathode, $90$ $\mathrm{nC}/\mathrm{m}^3$, reflects both the expected rate of cosmic ray charge deposition and effects of recombination~\cite{KirkSCE}. The distribution is independent of $y$ and $z$ in the simulation (an approximation).}
\includegraphics[width=.6\textwidth]{SCprofile.png}
\end{cdrfigure}


Some of the simulation results are shown in Figure~\ref{fig:simexample_Evals} and Figure~\ref{fig:simexample_Dvals}, which illustrate the impact of space charge on both the drift electric field (Figure~\ref{fig:simexample_Evals}) as well as the distortions in reconstructed ionization electron cluster position (Figure~\ref{fig:simexample_Dvals}).  At a drift field of 500~V/cm (corresponding to expected conditions during data-taking at protoDUNE), the expected maximal impact on the electric field is roughly 10\% in both the drift and transverse directions.

\begin{cdrfigure}[Simulated effects of space charge on the drift electric field in the ProtoDUNE-SP TPC]{simexample_Evals}{Illustration of the simulated effects of space charge on the drift electric field in the ProtoDUNE-SP TPC.  Results are shown for the effect in $x$ (top row), $y$ (middle row), and $z$ (bottom row).  The electric field distortions are normalized to the nominal drift electric field magnitude ($E_{0}$) of 500~V/cm and are plotted as a function of the true position in the TPC.  Simulation results are shown both for a central slice in $z$ (left column) and for a slice in $z$ closer to the end of the TPC, $z$ = 19 cm (right column).}
\includegraphics[width=.41\textwidth]{Ex_center_ProtoDUNE_E500.pdf}
\includegraphics[width=.41\textwidth]{Ex_end_ProtoDUNE_E500.pdf}
\\
\includegraphics[width=.41\textwidth]{Ey_center_ProtoDUNE_E500.pdf}
\includegraphics[width=.41\textwidth]{Ey_end_ProtoDUNE_E500.pdf}
\\
\includegraphics[width=.41\textwidth]{Ez_center_ProtoDUNE_E500.pdf}
\includegraphics[width=.41\textwidth]{Ez_end_ProtoDUNE_E500.pdf}
\end{cdrfigure}

\begin{cdrfigure}[Simulated effects of space charge on distortions in recon ionization e- cluster position]{simexample_Dvals}{Illustration of the simulated effects of space charge on the distortions in reconstructed ionization electron cluster position in the ProtoDUNE-SP TPC.  Results are shown for the effect in $x$ (top row), $y$ (middle row), and $z$ (bottom row).  The distortions in reconstructed ionization electron cluster position are shown in units of cm and are plotted as a function of the true position in the TPC.  Simulation results are shown both for a central slice in $z$ (left column) and for a slice in $z$ closer to the end of the TPC, $z$ = 19 cm (right column).}
\includegraphics[width=.41\textwidth]{Dx_center_ProtoDUNE_E500.pdf}
\includegraphics[width=.41\textwidth]{Dx_end_ProtoDUNE_E500.pdf}
\\
\includegraphics[width=.41\textwidth]{Dy_center_ProtoDUNE_E500.pdf}
\includegraphics[width=.41\textwidth]{Dy_end_ProtoDUNE_E500.pdf}
\\
\includegraphics[width=.41\textwidth]{Dz_center_ProtoDUNE_E500.pdf}
\includegraphics[width=.42\textwidth]{Dz_end_ProtoDUNE_E500.pdf}
\end{cdrfigure}



While the simulation provides a useful order-of-magnitude estimation of the distortions in electric field and reconstructed ionization electron cluster position within the ProtoDUNE-SP TPC, and provides basic shape features that we might expect in the data, there are several understood limitations of the simulation.  First of all, the flow of liquid argon, which may move positive argon ions in or out of the active TPC volume, is not considered.  Also, the assumption of uniform charge deposition from cosmics throughout the TPC may not be the case in reality, as enhanced cosmogenic activity near the top of the detector may lead to greater ion production rates closer to the top of the TPC active volume.  Finally, the linear space charge density assumed in the simulation (see Figure~\ref{fig:simSCDist}) is not quite correct; this approximates the ion drift speed (roughly 8~mm/s at a drift field of 500~V/cm) as constant throughout the TPC, while in reality the electric field distortions arising from the SCE itself would break this assumption.  With that in mind, comparisons of the simulation to first data collected at MicroBooNE show good agreement in terms of both magnitude and shape, looking at the top and bottom of the MicroBooNE TPC, with minor discrepancies due to what is believed to be effects of liquid argon flow moving space charge outside of the TPC active volume~\cite{SCEnoteMicroBooNE}.

%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Calibration} \label{sec:SCEcalib}
\fixme{consider moving this section to overall detector calibration section; minimize reference to laser system}

In order to correct SCE distortions (both electric field and reconstructed ionization electron cluster position) in data, a robust calibration scheme is necessary.  With information about the true position of ionization within the TPC in hand, as well as the reconstructed position of the ionization, spatial distortions of ionization deposition position can be extracted throughout the TPC active volume.  These spatial distortions can then be used to calculate the amount of electric field distortion throughout the TPC active volume.  Together, these two distortion maps can be used to correct track angles and calibrate out the variation in recombination and scintillation light yield throughout the TPC.

The strategy outlined above necessitates knowing both true and reconstructed ionization electron cluster positions throughout the TPC active volume.  This information can be obtained by using either cosmic muons or laser tracks.  In the case of cosmic muons, the ends of the tracks at the edges of the TPC active volume can be used to determine the spatial offsets due to SCE in the parts of the TPC where the transverse SCE is expected to be largest (see Figure~\ref{fig:simexample_Dvals}).  This first requires determining the $t_0$ of the cosmic muon, which can be obtained by either using a light-collection system or an external tagger (such as scintillator paddles located outside of the cryostat).  In the case of laser tracks, the true laser path through the TPC is known, allowing for calibration of spatial offsets due to SCE in the bulk of the TPC.  Together, cosmic muons and laser tracks (from e.g., a UV laser system installed at opposite ends of the cryostat~\cite{Ereditato:2014lra}) can be utilized to obtain SCE corrections throughout the entire TPC active volume.

Such calibration techniques discussed above require that the disortions due to SCE be relatively stable over time.  Preliminary observations at MicroBooNE suggest that this is the case on the timescale of several months~\cite{SCEnoteMicroBooNE}, though for a different cryogenic system.  This last point is important to note as the liquid argon flow pattern may be significantly different at ProtoDUNE-SP, leading to a space charge profile that may be time-dependent.

